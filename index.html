import json
import os

class RiskMapConfigurator:
    def __init__(self, config_file='map_config.json'):
        """Initialize the risk map configurator"""
        self.config_file = config_file
        self.config = self.load_config()
        
        # Define risk categories
        self.risk_colors = {
            'High Risk': '#cc3333',
            'Medium Risk': '#ffff33',
            'Low Risk': '#33a02c',
            'Default': '#d1dbdd'
        }
        
    def load_config(self):
        """Load configuration from JSON file"""
        if os.path.exists(self.config_file):
            with open(self.config_file, 'r') as f:
                return json.load(f)
        return self.create_default_config()
    
    def create_default_config(self):
        """Create default configuration from your current map"""
        return {
            "groups": {
                "#cc3333": {
                    "label": "High Risk",
                    "paths": ["Ukraine", "Belarus", "Türkiye", "Mexico"]
                },
                "#ffff33": {
                    "label": "Medium Risk",
                    "paths": ["Greece", "Kazakhstan", "Moldova", "South_Africa", 
                             "Uzbekistan", "Mongolia"]
                },
                "#33a02c": {
                    "label": "Low Risk",
                    "paths": ["Austria", "Netherlands", "Bulgaria", "Czechia", 
                             "Germany", "Estonia", "Hungary", "Latvia", "Lithuania", 
                             "Romania", "Poland", "Slovakia", "Switzerland"]
                }
            },
            "defaultColor": "#d1dbdd",
            "borders": "#000"
        }
    
    def save_config(self):
        """Save current configuration to JSON file"""
        with open(self.config_file, 'w') as f:
            json.dump(self.config, indent=2, fp=f)
        print(f"✓ Configuration saved to {self.config_file}")
    
    def add_country(self, country_name, risk_level):
        """Add or update a country's risk level"""
        # Remove country from other risk levels first
        self.remove_country(country_name)
        
        # Find the color for this risk level
        color = self.risk_colors.get(risk_level)
        if not color:
            print(f"❌ Invalid risk level: {risk_level}")
            print(f"   Valid options: High Risk, Medium Risk, Low Risk")
            return
        
        # Add country to the appropriate group
        if color not in self.config['groups']:
            self.config['groups'][color] = {
                'label': risk_level,
                'paths': []
            }
        
        self.config['groups'][color]['paths'].append(country_name)
        print(f"✓ Added {country_name} to {risk_level}")
    
    def remove_country(self, country_name):
        """Remove a country from all risk levels"""
        for color, group in self.config['groups'].items():
            if country_name in group['paths']:
                group['paths'].remove(country_name)
    
    def update_country(self, country_name, new_risk_level):
        """Update a country's risk level"""
        old_risk = self.get_country_risk(country_name)
        self.add_country(country_name, new_risk_level)
        if old_risk != "Not assigned":
            print(f"  (Changed from {old_risk})")
    
    def get_country_risk(self, country_name):
        """Get the current risk level for a country"""
        for color, group in self.config['groups'].items():
            if country_name in group['paths']:
                return group['label']
        return "Not assigned"
    
    def list_countries_by_risk(self):
        """List all countries organized by risk level"""
        print("\n" + "="*50)
        print("    KDP GLOBAL RISK ASSESSMENT")
        print("="*50)
        
        # Count totals
        total = 0
        for color, group in self.config['groups'].items():
            total += len(group['paths'])
        
        print(f"\nTotal Countries Assessed: {total}\n")
        
        # Sort by risk level (High, Medium, Low)
        risk_order = ['High Risk', 'Medium Risk', 'Low Risk']
        
        for risk_level in risk_order:
            for color, group in self.config['groups'].items():
                if group['label'] == risk_level:
                    count = len(group['paths'])
                    print(f"\n{group['label'].upper()} ({count} countries):")
                    print("-" * 40)
                    for country in sorted(group['paths']):
                        print(f"  • {country}")
        
        print("\n" + "="*50 + "\n")
    
    def create_map_image(self, filename='Project_Unite_Risk_Map.html'):
        """Generate an interactive map visualization"""
        try:
            import plotly.graph_objects as go
            
            print("Generating map visualization...")
            
            # Create mapping of country names to risk levels
            country_risk = {}
            country_colors = {}
            
            for color, group in self.config['groups'].items():
                for country in group['paths']:
                    country_risk[country] = group['label']
                    country_colors[country] = color
            
            # Get all countries and their data
            countries = list(country_risk.keys())
            risks = [country_risk[c] for c in countries]
            colors = [country_colors[c] for c in countries]
            
            # Create the choropleth map
            fig = go.Figure(data=go.Choropleth(
                locations = countries,
                locationmode = 'country names',
                z = [3 if r == 'High Risk' else 2 if r == 'Medium Risk' else 1 for r in risks],
                text = countries,
                customdata = risks,
                colorscale = [
                    [0, '#33a02c'],      # Low Risk - Green
                    [0.5, '#ffff33'],    # Medium Risk - Yellow  
                    [1, '#cc3333']       # High Risk - Red
                ],
                autocolorscale=False,
                reversescale=False,
                marker_line_color='#000000',
                marker_line_width=1.5,
                colorbar=dict(
                    tickvals=[1, 2, 3],
                    ticktext=['Low Risk', 'Medium Risk', 'High Risk'],
                    title='Risk Level',
                    len=0.5,
                    lenmode='fraction'
                ),
                hovertemplate='<b>%{text}</b><br>Risk Level: %{customdata}<extra></extra>',
                showscale=True
            ))
            
            fig.update_layout(
                title={
                    'text': 'Project Unite Operational Risk Registry',
                    'y':0.95,
                    'x':0.5,
                    'xanchor': 'center',
                    'yanchor': 'top',
                    'font': {'size': 24, 'color': '#2c3e50', 'family': 'Arial Black'}
                },
                geo=dict(
                    showframe=True,
                    showcountries=True,
                    showcoastlines=True,
                    countrycolor='darkgray',
                    countrywidth=1,
                    projection_type='natural earth',
                    bgcolor='rgba(240,240,240,0.5)',
                    showland=True,
                    landcolor='#e8e8e8'
                ),
                width=1600,
                height=900,
                paper_bgcolor='white',
                font=dict(family='Arial', size=12)
            )
            
            # Save as HTML (interactive)
            fig.write_html(filename)
            print(f"✓ Interactive map saved as: {filename}")
            print(f"  Open this file in your web browser to see the map!")
            print(f"  (Hover over countries to see their names and risk levels)")
            
            # Try to save as static image (PNG) if kaleido is installed
            try:
                png_filename = filename.replace('.html', '.png')
                fig.write_image(png_filename, width=1600, height=900)
                print(f"✓ Static image saved as: {png_filename}")
                print(f"  You can insert this PNG into PowerPoint/reports!")
            except:
                print("\nℹ️  To save as PNG for PowerPoint, install kaleido:")
                print("   pip install kaleido")
            
            return fig
            
        except ImportError:
            print("❌ plotly not installed.")
            print("\nTo generate maps, run this in Spyder console:")
            print("   pip install plotly")
            print("\nFor PNG images (optional), also run:")
            print("   pip install kaleido")
            return None
    
    def export_to_excel(self, filename='KDP_Risk_Assessment.xlsx'):
        """Export to Excel format"""
        try:
            import pandas as pd
            
            # Create a list of all countries with their risk levels
            data = []
            for color, group in self.config['groups'].items():
                for country in group['paths']:
                    data.append({
                        'Country': country,
                        'Risk Level': group['label'],
                        'Color Code': color
                    })
            
            # Create DataFrame and save
            df = pd.DataFrame(data)
            df = df.sort_values(['Risk Level', 'Country'])
            df.to_excel(filename, index=False)
            print(f"✓ Exported to {filename}")
            
        except ImportError:
            print("❌ pandas not installed. Run: pip install pandas openpyxl")


# Example usage
if __name__ == "__main__":
    # Initialize configurator
    mapper = RiskMapConfigurator()
    
    # Show current configuration
    mapper.list_countries_by_risk()
    
    # Generate the map!
    print("\n" + "="*50)
    mapper.create_map_image('Project_Unite_Risk_Map.html')
    print("="*50)

